<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Dashboard</title>
    <link rel="stylesheet" href="/css/layout.css">
    <style>
/* KPI Container Styles */
/* Loading Popup Styles */
.loading-popup {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);  /* Semi-transparent black */
    display: none;  /* Hidden by default */
    justify-content: center;
    align-items: center;
    text-align: center;
    z-index: 9999;  /* Make sure it's on top of everything */
}

.spinner {
    border: 4px solid rgba(255, 255, 255, 0.3); /* White border */
    border-top: 4px solid #fff;  /* White color for the spinner top */
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite; /* Spinner animation */
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

p {
    color: white;
    margin-top: 10px;
    font-size: 18px;
}



    </style>
</head>
<body>
    <div class="sidebar">
        <h2>HR Panel</h2>
        <ul>
            <li><a href="/dashboard">Dashboard</a></li>
            <li><a href="/hr_manager/employee_management">Employee Management</a></li>
            <li><a href="/hr_manager/leave_request">Leave Requests</a></li>
            <li><a href="/hr_manager/employee_attendance">Employee Attendance</a></li>
            <li><a href="/hr_manager/payroll">Payroll Management</a></li>
            <li><a href="/hr_manager/reports">Reports</a></li>
            <li><a href="/hr_manager/attendance">Attendance</a></li>
            <li><a href="/hr_manager/recruitment">Recruitment</a></li>
            <li><a href="/hr_manager/employee_list">Employee Directory</a></li>
            <li><a href="/logout" id="logout-button">Logout</a></li>
        </ul>
    </div>

    <div class="container">
        <h2>All Pending Requests</h2>
        <button onclick="loadAllPendingRequests()">Load All Pending Requests</button>
        <br><br>
        <label for="userId">Filter by User ID:</label>
        <input type="number" id="userId" placeholder="Enter User ID">
        <button onclick="loadPendingRequestsByUserId()">Load Pending Requests by User</button>

        <table id="requestsTable">
            <thead>
                <tr>
                    <th>User ID</th>
                    <th>Request Date</th>
                    <th>Request Type</th>
                    <th>Remarks</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="loadingPopup" class="loading-popup">
        <div class="spinner"></div>
        <p>Loading...</p>
    </div>
    
        <script>

window.onload = async function() {
    await loadAllPendingRequests(); // Load all pending requests when the page loads
};

// Fetch all pending requests for HR Head
async function loadAllPendingRequests() {
    try {
        const response = await fetch('/hr/requests');
        const data = await response.json();

        if (Array.isArray(data.requests)) {
            const tableBody = document.querySelector('#requestsTable tbody');
            tableBody.innerHTML = ''; // Clear existing rows

            data.requests.forEach(request => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${request.user_id}</td>
                    <td>${request.request_date}</td>
                    <td>${request.request_type}</td>
                    <td>${request.remarks}</td>
                    <td>${request.status}</td>
                    <td>
                        <button onclick="handleRequestApproval(${request.user_id}, '${request.request_type}', true)">Approve</button>
                        <button onclick="handleRequestApproval(${request.user_id}, '${request.request_type}', false)">Reject</button>

                    </td>
                `;
                tableBody.appendChild(row);
            });
        } else {
            console.error('Invalid data format:', data);
            alert('Failed to load pending requests');
        }
    } catch (error) {
        console.error('Error loading pending requests:', error);
        alert('Error loading pending requests');
    }
}

// Fetch pending requests by user_id (for HR Head to filter by user)
async function loadPendingRequestsByUserId() {
    const userId = document.getElementById('userId').value;
    if (!userId) {
        alert('Please enter a valid User ID');
        return;
    }

    try {
        const response = await fetch(`/hr/requests/${userId}`);
        const data = await response.json();

        if (Array.isArray(data.requests)) {
            const tableBody = document.querySelector('#requestsTable tbody');
            tableBody.innerHTML = ''; // Clear existing rows

            data.requests.forEach(request => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${request.user_id}</td>
                    <td>${request.request_date}</td>
                    <td>${request.request_type}</td>
                    <td>${request.remarks}</td>
                    <td>${request.status}</td>
                    <td>
                        <button onclick="handleRequestApproval(${request.user_id}, '${request.request_type}', true)">Approve</button>
                        <button onclick="handleRequestApproval(${request.user_id}, '${request.request_type}', false)">Reject</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        } else {
            console.error('Invalid data format:', data);
            alert('Failed to load pending requests for user');
        }
    } catch (error) {
        console.error('Error loading pending requests:', error);
        alert('Error loading pending requests');
    }
}

// Approve or Reject a request
async function handleRequestApproval(userId, requestType, isApproved) {
    console.log('User ID:', userId);
    console.log('Request Type:', requestType);  // Should be a string like 'halfDay', 'earlyOut', or 'overtime'
    console.log('Is Approved:', isApproved);  // Should be a boolean (true or false)

    // Ensure requestType is valid
    const validRequestTypes = ['halfDay', 'earlyOut', 'overtime']; // List of valid request types
    if (!validRequestTypes.includes(requestType)) {
        console.error('Invalid requestType:', requestType);
        alert('Invalid request type!');
        return;
    }

    // Ensure isApproved is a boolean
    if (typeof isApproved !== 'boolean') {
        console.error('Invalid isApproved value:', isApproved);
        alert('Invalid approval status!');
        return;
    }

    // Ensure userId and requestType are valid
    if (userId === undefined || userId === null || requestType === undefined || requestType === null) {
        console.error('Invalid userId or requestType!');
        alert('Invalid request data!');
        return;
    }

    showLoadingPopup();

    try {
        const response = await fetch('/hr/approve', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId, requestType, isApproved }) // Send userId and requestType to the backend
        });

        const data = await response.json();
        if (data.success) {
            alert('Request updated successfully!');
            loadAllPendingRequests(); // Reload the requests table to reflect changes
        } else {
            alert('Error updating request.');
        }
    } catch (error) {
        alert('Error: ' + error);
    } finally {
        // Hide the loading popup once the request is completed (success or failure)
        hideLoadingPopup();
    }
}


function showLoadingPopup() {
    const loadingPopup = document.getElementById('loadingPopup');
    loadingPopup.style.display = 'flex';  // Make it visible
}

// Hide the loading popup
function hideLoadingPopup() {
    const loadingPopup = document.getElementById('loadingPopup');
    loadingPopup.style.display = 'none';  // Hide the popup
}
        </script>
    </body>
</html>
