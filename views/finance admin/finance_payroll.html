<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Payroll</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/side_top.css">
    <script src="/js/side_top.js"></script>
    <style>
        #content { margin-left: 0; transition: margin-left 0.3s; padding: 20px; }
        .table { width: 100%; margin-top: 30px; }
        .payroll-status { padding: 5px 10px; border-radius: 15px; font-size: 0.9em; font-weight: bold; }
        .status-pending { background-color: #ffc107; color: #000; }
        .status-approved { background-color: #28a745; color: #fff; }
        .status-rejected { background-color: #dc3545; color: #fff; }
        .action-buttons { display: flex; gap: 5px; }
        .action-btn { padding: 5px 8px; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; color: white; }
        .approve-btn { background-color: #198754; }
        .approve-btn:hover { background-color: #157347; }
        .reject-btn { background-color: #dc3545; }
        .reject-btn:hover { background-color: #bb2d3b; }
        /* --- Payroll search/filter row --- */
        .search-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
        }
        .search-container .form-control {
            min-width: 260px;
            max-width: 320px;
            height: 40px;
        }
        .search-container .form-select {
            width: 160px;
            height: 40px;
        }
        .entries-per-page {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .entries-per-page label {
            margin-bottom: 0;
            font-weight: 500;
            font-size: 15px;
        }
        .entries-per-page .form-select {
            width: 80px;
            height: 36px;
        }
        @media (max-width: 900px) {
            .search-container { flex-direction: column; align-items: stretch; gap: 8px; }
            .entries-per-page { margin-left: 0; justify-content: flex-start; }
        }
        @media print {
            body * { visibility: hidden !important; }
            #payrollSummaryPrintArea, #payrollSummaryPrintArea * { visibility: visible !important; }
            #payrollSummaryPrintArea {
                position: absolute !important;
                left: 0; top: 0; width: 100vw; min-height: 100vh;
                background: #fff !important;
                padding: 0 !important;
                margin: 0 !important;
                box-shadow: none !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            #payrollSummaryPrintArea .payroll-header {
                background: #000 !important;
                color: #fff !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            #payrollSummaryPrintArea img[alt="MDB Construction Logo"] {
                display: block !important;
                visibility: visible !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                max-height: 60px !important;
                max-width: 100px !important;
            }
            #payrollSummaryPrintArea table thead tr {
                background: #11336b !important;
                color: #fff !important;
            }
            #payrollSummaryPrintArea table thead th {
                background: #11336b !important;
                color: #fff !important;
            }
            #payrollSummaryPrintArea table tbody tr:nth-child(even) {
                background: #f1f6ff !important;
            }
            #payrollSummaryPrintArea table tbody tr:nth-child(odd) {
                background: #f8f9fa !important;
            }
            #payrollSummaryPrintArea table td, #payrollSummaryPrintArea table th {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            #payrollSummaryPrintArea .signature-line {
                border-bottom: 2.5px solid #1976d2 !important;
            }
        }
        .payroll-summary-professional {
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 700px;
            margin: 0 auto;
            background: #fff;
            padding: 32px 32px 48px 32px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            border: 1.5px solid #e0e0e0;
            position: relative;
        }
        .payroll-summary-professional .summary-logo {
            text-align: center;
            margin-bottom: 10px;
        }
        .payroll-summary-professional .summary-logo img {
            height: 48px;
        }
        .payroll-summary-professional .summary-title {
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 4px;
            letter-spacing: 1px;
            color: #1a237e;
        }
        .payroll-summary-professional .summary-meta {
            text-align: center;
            font-size: 1.1rem;
            margin-bottom: 24px;
            color: #555;
        }
        .payroll-summary-professional table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 16px;
            background: #fafbfc;
        }
        .payroll-summary-professional th, .payroll-summary-professional td {
            padding: 12px 10px;
            text-align: left;
            font-size: 1.08rem;
        }
        .payroll-summary-professional th {
            background: #f4f6fa;
            font-weight: 600;
            border-bottom: 2px solid #e0e0e0;
            width: 60%;
        }
        .payroll-summary-professional td {
            font-weight: 500;
            color: #222;
        }
        .payroll-summary-professional tr:not(:last-child) td {
            border-bottom: 1px solid #e0e0e0;
        }
        .payroll-summary-professional .summary-footer {
            margin-top: 32px;
            text-align: right;
            font-size: 1rem;
            color: #888;
        }
        .payroll-summary-professional .summary-signature {
            margin-top: 48px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }
        .payroll-summary-professional .summary-signature .sig-line {
            border-bottom: 1.5px solid #222;
            width: 220px;
            margin-right: 16px;
            height: 2px;
        }
        .payroll-summary-professional .summary-signature .sig-label {
            font-size: 1rem;
            color: #333;
            font-weight: 500;
        }
    </style>
</head>
<body>
   <!-- Topbar -->
   <div class="topbar">
    <div class="topbar-left">
        <div class="menu-toggle" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </div>
    </div>
    <div class="topbar-right">
        <div class="notification-icon" onclick="toggleNotifications()">
            <i class="fas fa-bell"></i>
            <span class="notification-badge"></span>
        </div>
        <div class="profile-section" onclick="window.location.href='/hr/hr_profile'">
            <div class="profile-info">
                <div class="profile-name"></div>
                <div class="profile-position"></div>
            </div>
            <div class="profile-picture-container" style="width: 40px; height: 40px; margin: 0;">
                <img src="/hr/default-profile-picture" alt="Profile" class="profile-picture" id="topbarProfilePicture">
            </div>
        </div>
    </div>
    
    <!-- Notification Dropdown -->
    <div class="notification-dropdown" id="notificationDropdown">
        <div class="notification-header">
            <span>Notifications</span>
            <button class="mark-all-read" onclick="markAllAsRead()">Mark all as read</button>
        </div>
        <div class="notification-item">
            <div class="notification-title">New Leave Request</div>
            <div class="notification-time">5 minutes ago</div>
        </div>
        <div class="notification-item">
            <div class="notification-title">Payroll Processed</div>
            <div class="notification-time">1 hour ago</div>
        </div>
        <div class="notification-item">
                <span class="profile-name">John Doe</span>
                <span class="profile-position">HR Manager</span>
            </div>
        </div>
        
        <!-- Notification Dropdown -->
        <div class="notification-dropdown" id="notificationDropdown">
            <div class="notification-header">
                <span>Notifications</span>
                <button class="mark-all-read" onclick="markAllAsRead()">Mark all as read</button>
            </div>
            <div class="notification-item">
                <div class="notification-title">New Leave Request</div>
                <div class="notification-time">5 minutes ago</div>
            </div>
            <div class="notification-item">
                <div class="notification-title">Payroll Processed</div>
                <div class="notification-time">1 hour ago</div>
            </div>
            <div class="notification-item">
                <div class="notification-title">New Employee Added</div>
                <div class="notification-time">2 hours ago</div>
            </div>
        </div>
    </div>
</div>
    <!-- Sidebar -->
    <div id="sidebar">
        <div class="sidebar-header">
            <img src="/image/mdb-removebg-preview.png" alt="MDB Logo">
            <span class="company-title">MDB Construction</span>
        </div>
        <ul class="list-unstyled">
            <li class="nav-item">
                <a class="nav-item" href="/finance/finance_dashboard"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a>
            </li>
            <li class="nav-item">
                <a href="#" data-bs-toggle="collapse" data-bs-target="#Attendance" aria-expanded="false">
                    <i class="fas fa-calendar-check"></i> Attendance
                </a>
                <ul class="collapse" id="Attendance">
                    <li class="nav-item"><a href="/finance/finance_daily_attendance"><i class="fas fa-calendar-check"></i> <span>Daily Attendance</span></a></li>
                    <li class="nav-item"><a href="/finance/finance_leave_request"><i class="fas fa-file-invoice"></i> <span>Request Leave</span></a></li>
                    <li class="nav-item"><a href="/finance/finance_halfday"><i class="fas fa-clock"></i> <span>Request Halfday</span></a></li>
                    <li class="nav-item"><a href="/finance/finance_overtime"><i class="fas fa-business-time"></i> <span>Request Overtime</span></a></li>
                </ul>
            </li>
            <li class="nav-item">
                <a href="/finance/finance_payroll"><i class="fas fa-money-bill-wave"></i> Payroll</a>
            </li>
            <li class="nav-item">
                <a href="#" data-bs-toggle="collapse" data-bs-target="#Purchase" aria-expanded="false">
                    <i class="fas fa-shopping-cart"></i> Purchase
                </a>
                <ul class="collapse" id="Purchase">
                    <li class="nav-item"><a href="/finance/finance_purchase_request"><i class="fas fa-file-invoice"></i> <span >Purchase Request</span></a></li>
                    <li class="nav-item"><a href="/finance/finance_purchase_order"><i class="fas fa-file-invoice-dollar"></i> <span>Purchase Order</span></a></li>
                </ul>
            </li>
            <li class="logout nav-item"><a href="/logout"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a></li>
        </ul>
    </div>
    <div id="content">
        <h2>Payroll Management</h2>
        <div class="search-container mb-2">
            <input type="text" id="searchBar" class="form-control" placeholder="Search by name, position, or ID...">
            <select id="statusFilter" class="form-select ms-2" style="min-width:150px;" aria-label="Filter by status">
                <option value="all">All Status</option>
                <option value="pending">Pending</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
            </select>
            <button id="printSummaryBtn" class="btn btn-outline-primary ms-2" disabled><i class="fas fa-print"></i> Payroll Summary</button>
            <div class="entries-per-page ms-auto d-flex align-items-center">
                <label for="entriesPerPageSelect" class="me-2 mb-0">Entries per page:</label>
                <select id="entriesPerPageSelect" class="form-select">
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="15">15</option>
                </select>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-striped" id="payrollTable">
                <thead>
                    <tr>
                        <th onclick="sortPayroll('id')">Employee ID <i class="fas fa-sort sort-icon"></i></th>
                        <th onclick="sortPayroll('name')">Full Name <i class="fas fa-sort sort-icon"></i></th>
                        <th onclick="sortPayroll('position')">Position <i class="fas fa-sort sort-icon"></i></th>
                        <th onclick="sortPayroll('startDate')">Start Date <i class="fas fa-sort sort-icon"></i></th>
                        <th onclick="sortPayroll('endDate')">End Date <i class="fas fa-sort sort-icon"></i></th>
                        <th onclick="sortPayroll('daysPresent')">Days Present <i class="fas fa-sort sort-icon"></i></th>
                        <th onclick="sortPayroll('totalHours')">Total Hours <i class="fas fa-sort sort-icon"></i></th>
                        <th onclick="sortPayroll('overtimeHours')">Overtime Hours <i class="fas fa-sort sort-icon"></i></th>
                        <th onclick="sortPayroll('fixedSalary')">Fixed Salary <i class="fas fa-sort sort-icon"></i></th>
                        <th onclick="sortPayroll('salaryBeforeTax')">Salary Before Tax <i class="fas fa-sort sort-icon"></i></th>
                        <th onclick="sortPayroll('totalDeductions')">Total Deductions <i class="fas fa-sort sort-icon"></i></th>
                        <th onclick="sortPayroll('netPay')">Net Pay <i class="fas fa-sort sort-icon"></i></th>
                        <th onclick="sortPayroll('status')">Status <i class="fas fa-sort sort-icon"></i></th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="payrollList"></tbody>
            </table>
        </div>
        <div id="entriesMessage" class="d-flex justify-content-between align-items-center mt-2">
            <span id="showingEntries"></span>
            <nav><ul class="pagination mb-0" id="paginationControls"></ul></nav>
        </div>
    </div>

    <!-- View Payroll Modal -->
    <div class="modal fade" id="viewPayrollModal" tabindex="-1" aria-labelledby="viewPayrollModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="viewPayrollModalLabel"><i class="fas fa-user"></i> Payroll Details</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="container-fluid">
              <div class="row mb-3">
                <div class="col-md-4 text-center">
                  <div class="mx-auto mb-2" style="width:80px;height:80px;">
                    <img id="modalProfilePic" src="" alt="Profile" class="rounded-circle border border-2" style="width:80px;height:80px;object-fit:cover;">
                  </div>
                  <h5 id="modalFullName" class="fw-bold mb-0"></h5>
                  <div id="modalPosition" class="text-muted"></div>
                  <span id="modalStatus" class="payroll-status mt-2"></span>
                </div>
                <div class="col-md-8">
                  <div class="row g-2">
                    <div class="col-6">
                      <small class="text-muted">Employee ID</small>
                      <div id="modalEmployeeId" class="fw-semibold"></div>
                    </div>
                    <div class="col-6">
                      <small class="text-muted">Period</small>
                      <div><span id="modalStartDate"></span> - <span id="modalEndDate"></span></div>
                    </div>
                    <div class="col-4">
                      <small class="text-muted">Days Present</small>
                      <div id="modalDaysPresent"></div>
                    </div>
                    <div class="col-4">
                      <small class="text-muted">Total Hours</small>
                      <div id="modalTotalHours"></div>
                    </div>
                    <div class="col-4">
                      <small class="text-muted">Overtime Hours</small>
                      <div id="modalOvertimeHours"></div>
                    </div>
                  </div>
                </div>
              </div>
              <hr>
              <div class="row g-3">
                <div class="col-md-4">
                  <div class="card border-0 shadow-sm">
                    <div class="card-body">
                      <div class="d-flex align-items-center mb-2"><i class="fas fa-money-bill-wave me-2 text-success"></i> <span class="fw-bold">Fixed Salary</span></div>
                      <div id="modalFixedSalary" class="fs-5"></div>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card border-0 shadow-sm">
                    <div class="card-body">
                      <div class="d-flex align-items-center mb-2"><i class="fas fa-coins me-2 text-warning"></i> <span class="fw-bold">Salary Before Tax</span></div>
                      <div id="modalSalaryBeforeTax" class="fs-5"></div>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card border-0 shadow-sm">
                    <div class="card-body">
                      <div class="d-flex align-items-center mb-2"><i class="fas fa-minus-circle me-2 text-danger"></i> <span class="fw-bold">Total Deductions</span></div>
                      <div id="modalTotalDeductions" class="fs-5"></div>
                    </div>
                  </div>
                </div>
                <div class="col-md-12 mt-3">
                  <div class="card border-0 shadow">
                    <div class="card-body bg-success bg-opacity-10 rounded">
                      <div class="d-flex align-items-center mb-2"><i class="fas fa-wallet me-2 text-success"></i> <span class="fw-bold">Net Pay</span></div>
                      <div id="modalNetPay" class="fs-4 fw-bold text-success"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" id="modalApproveBtn" class="btn btn-success"><i class="fas fa-check"></i> Approve</button>
            <button type="button" id="modalRejectBtn" class="btn btn-danger"><i class="fas fa-times"></i> Reject</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0">
          <div class="modal-body text-center p-5">
            <div id="confirmIcon" class="mb-3"></div>
            <h4 id="confirmTitle" class="mb-3"></h4>
            <div id="confirmModalBody" class="mb-4"></div>
            <div id="remarksFormContainer" class="mb-3" style="display:none;">
              <textarea id="remarksInput" class="form-control" rows="3" placeholder="Enter remarks (required)"></textarea>
              <div id="remarksError" class="text-danger small mt-1" style="display:none;">Remarks are required to reject payroll.</div>
            </div>
            <div class="d-flex justify-content-center gap-3">
              <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Cancel</button>
              <button type="button" id="confirmActionBtn" class="btn px-4"></button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Payroll Summary Modal -->
    <div class="modal fade" id="payrollSummaryModal" tabindex="-1" aria-labelledby="payrollSummaryModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="payrollSummaryModalLabel"><i class="fas fa-file-invoice-dollar"></i> Payroll Summary</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="payrollSummaryContent" class="payroll-summary-professional"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" id="printPayrollSummaryBtn" class="btn btn-primary"><i class="fas fa-print"></i> Print</button>
            <button type="button" id="downloadPayrollSummaryBtn" class="btn btn-success"><i class="fas fa-download"></i> Download PDF</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Move all scripts to the end of body -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Global variables for payroll table state
        let payrolls = [];
        let payrollCurrentPage = 1;
        let payrollItemsPerPage = 5;
        let payrollSortColumn = null;
        let payrollSortDirection = 'asc';
        let payrollSearchValue = '';
        let payrollStatusFilter = 'all';
        let currentPayrollIdx = null;
        let pendingAction = null;

        // Initialize payroll table functionality
        function initializePayrollTable() {
            // Set up event listeners
            document.getElementById('searchBar').addEventListener('input', function(e) {
                payrollSearchValue = e.target.value;
                payrollCurrentPage = 1;
                renderPayrolls();
            });

            document.getElementById('statusFilter').addEventListener('change', function(e) {
                payrollStatusFilter = e.target.value;
                payrollCurrentPage = 1;
                renderPayrolls();
            });

            document.getElementById('entriesPerPageSelect').addEventListener('change', function(e) {
                payrollItemsPerPage = parseInt(e.target.value);
                payrollCurrentPage = 1;
                renderPayrolls();
            });

            // Set up modal event listeners
            document.getElementById('modalApproveBtn').addEventListener('click', handleApprovePayroll);
            document.getElementById('modalRejectBtn').addEventListener('click', handleRejectPayroll);
            document.getElementById('confirmActionBtn').addEventListener('click', handleConfirmAction);
            document.getElementById('printSummaryBtn').addEventListener('click', handlePrintSummary);
            document.getElementById('printPayrollSummaryBtn').addEventListener('click', handlePrintPayrollSummary);
            document.getElementById('downloadPayrollSummaryBtn').addEventListener('click', handleDownloadPayrollSummary);

            // Fetch initial data
            fetchPayrolls();
        }

        // Fetch payrolls from the server
        async function fetchPayrolls() {
            try {
                const response = await fetch('/finance/payrolls');
                const result = await response.json();
                
                if (result.success) {
                    payrolls = result.data;
                    renderPayrolls();
                } else {
                    console.error('Failed to fetch payrolls:', result.message);
                    document.getElementById('payrollList').innerHTML = `
                        <tr>
                            <td colspan="14" class="text-center text-danger">
                                Failed to load payroll data. Please try again later.
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Error fetching payrolls:', error);
                document.getElementById('payrollList').innerHTML = `
                    <tr>
                        <td colspan="14" class="text-center text-danger">
                            Error connecting to server. Please check your connection and try again.
                        </td>
                    </tr>
                `;
            }
        }

        // Filter and sort payrolls
        function filterAndSortPayrolls() {
            let filtered = [...payrolls];

            // Apply search filter
            if (payrollSearchValue) {
                const searchLower = payrollSearchValue.toLowerCase();
                filtered = filtered.filter(payroll => 
                    payroll.name.toLowerCase().includes(searchLower) ||
                    payroll.position.toLowerCase().includes(searchLower) ||
                    payroll.employee_id.toString().includes(searchLower)
                );
            }

            // Apply status filter
            if (payrollStatusFilter !== 'all') {
                filtered = filtered.filter(payroll => payroll.status === payrollStatusFilter);
            }

            // Apply sorting
            if (payrollSortColumn) {
                filtered.sort((a, b) => {
                    let aVal = a[payrollSortColumn];
                    let bVal = b[payrollSortColumn];

                    // Handle numeric values
                    if (['total_hours', 'overtime_hours', 'fixed_salary', 'salary_before_tax', 
                         'total_deductions', 'net_salary', 'days_present', 'days_absent'].includes(payrollSortColumn)) {
                        aVal = parseFloat(aVal) || 0;
                        bVal = parseFloat(bVal) || 0;
                    }

                    // Handle date values
                    if (['start_date', 'end_date', 'payroll_date'].includes(payrollSortColumn)) {
                        aVal = new Date(aVal);
                        bVal = new Date(bVal);
                    }

                    if (aVal < bVal) return payrollSortDirection === 'asc' ? -1 : 1;
                    if (aVal > bVal) return payrollSortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            return filtered;
        }

        // Render payrolls in the table
        function renderPayrolls() {
            const filtered = filterAndSortPayrolls();
            const start = (payrollCurrentPage - 1) * payrollItemsPerPage;
            const end = start + payrollItemsPerPage;
            const paginatedPayrolls = filtered.slice(start, end);

            const tbody = document.getElementById('payrollList');
            tbody.innerHTML = '';

            if (paginatedPayrolls.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="14" class="text-center">
                            No payroll records found
                        </td>
                    </tr>
                `;
                return;
            }

            paginatedPayrolls.forEach((payroll, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${payroll.employee_id}</td>
                    <td>${payroll.name}</td>
                    <td>${payroll.position}</td>
                    <td>${formatDate(payroll.start_date)}</td>
                    <td>${formatDate(payroll.end_date)}</td>
                    <td>${payroll.days_present}</td>
                    <td>${formatNumber(payroll.total_hours)}</td>
                    <td>${formatNumber(payroll.overtime_hours)}</td>
                    <td>${formatCurrency(payroll.fixed_salary)}</td>
                    <td>${formatCurrency(payroll.salary_before_tax)}</td>
                    <td>${formatCurrency(payroll.total_deductions)}</td>
                    <td>${formatCurrency(payroll.net_salary)}</td>
                    <td><span class="payroll-status status-${payroll.status.toLowerCase()}">${payroll.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn btn btn-sm btn-primary" onclick="viewPayroll(${index})">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${payroll.status === 'pending' ? `
                                <button class="action-btn btn btn-sm btn-success" onclick="approvePayroll(${index})">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="action-btn btn btn-sm btn-danger" onclick="rejectPayroll(${index})">
                                    <i class="fas fa-times"></i>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });

            updatePayrollEntriesMessage(filtered.length);
            updatePayrollPagination(filtered.length);
            updatePrintSummaryBtn(filtered.length > 0);
        }

        // Helper functions for formatting
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function formatNumber(number) {
            return parseFloat(number).toFixed(2);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-PH', {
                style: 'currency',
                currency: 'PHP'
            }).format(amount);
        }

        // Update entries message
        function updatePayrollEntriesMessage(total) {
            const start = (payrollCurrentPage - 1) * payrollItemsPerPage + 1;
            const end = Math.min(start + payrollItemsPerPage - 1, total);
            document.getElementById('showingEntries').textContent = 
                `Showing ${start} to ${end} of ${total} entries`;
        }

        // Update pagination controls
        function updatePayrollPagination(total) {
            const totalPages = Math.ceil(total / payrollItemsPerPage);
            const pagination = document.getElementById('paginationControls');
            pagination.innerHTML = '';

            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${payrollCurrentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `
                <a class="page-link" href="#" onclick="changePayrollPage(${payrollCurrentPage - 1})" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            `;
            pagination.appendChild(prevLi);

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === payrollCurrentPage ? 'active' : ''}`;
                li.innerHTML = `
                    <a class="page-link" href="#" onclick="changePayrollPage(${i})">${i}</a>
                `;
                pagination.appendChild(li);
            }

            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${payrollCurrentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `
                <a class="page-link" href="#" onclick="changePayrollPage(${payrollCurrentPage + 1})" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            `;
            pagination.appendChild(nextLi);
        }

        // Change page
        function changePayrollPage(page) {
            if (page < 1 || page > Math.ceil(payrolls.length / payrollItemsPerPage)) return;
            payrollCurrentPage = page;
                renderPayrolls();
        }

        // Sort payrolls
        function sortPayroll(column) {
            if (payrollSortColumn === column) {
                payrollSortDirection = payrollSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                payrollSortColumn = column;
                payrollSortDirection = 'asc';
            }
            renderPayrolls();
        }

        // Update print summary button state
        function updatePrintSummaryBtn(hasData) {
            const printBtn = document.getElementById('printSummaryBtn');
            printBtn.disabled = !hasData;
        }

        // View payroll details
        function viewPayroll(index) {
            const payroll = payrolls[index];
            currentPayrollIdx = index;

            // Update modal content
            document.getElementById('modalProfilePic').src = payroll.profile_picture || '/hr/default-profile-picture';
            document.getElementById('modalFullName').textContent = payroll.name;
            document.getElementById('modalPosition').textContent = payroll.position;
            document.getElementById('modalStatus').textContent = payroll.status;
            document.getElementById('modalStatus').className = `payroll-status status-${payroll.status.toLowerCase()}`;
            document.getElementById('modalEmployeeId').textContent = payroll.employee_id;
            document.getElementById('modalStartDate').textContent = formatDate(payroll.start_date);
            document.getElementById('modalEndDate').textContent = formatDate(payroll.end_date);
            document.getElementById('modalDaysPresent').textContent = payroll.days_present;
            document.getElementById('modalTotalHours').textContent = formatNumber(payroll.total_hours);
            document.getElementById('modalOvertimeHours').textContent = formatNumber(payroll.overtime_hours);
            document.getElementById('modalFixedSalary').textContent = formatCurrency(payroll.fixed_salary);
            document.getElementById('modalSalaryBeforeTax').textContent = formatCurrency(payroll.salary_before_tax);
            document.getElementById('modalTotalDeductions').textContent = formatCurrency(payroll.total_deductions);
            document.getElementById('modalNetPay').textContent = formatCurrency(payroll.net_salary);

            // Show/hide action buttons based on status
            const approveBtn = document.getElementById('modalApproveBtn');
            const rejectBtn = document.getElementById('modalRejectBtn');
            if (payroll.status === 'pending') {
                approveBtn.style.display = 'inline-block';
                rejectBtn.style.display = 'inline-block';
            } else {
                approveBtn.style.display = 'none';
                rejectBtn.style.display = 'none';
            }

            // Show modal
            const viewModal = new bootstrap.Modal(document.getElementById('viewPayrollModal'));
            viewModal.show();
        }

        // Approve payroll
        function approvePayroll(index) {
            currentPayrollIdx = index;
            handleApprovePayroll();
        }

        // Reject payroll
        function rejectPayroll(index) {
            currentPayrollIdx = index;
            handleRejectPayroll();
        }

        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Sidebar toggle functionality
            const sidebarToggle = document.querySelector('.menu-toggle');
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    const sidebar = document.getElementById('sidebar');
                    const content = document.getElementById('content');
                    if (sidebar.style.display === 'none' || sidebar.style.display === '') {
                        sidebar.style.display = 'block';
                        content.style.marginLeft = '300px';
                    } else {
                        sidebar.style.display = 'none';
                        content.style.marginLeft = '0';
                    }
                });
            }

            // Initialize payroll table
            initializePayrollTable();
        });

        // Modal handlers
        function handleApprovePayroll() {
            pendingAction = 'approved';
            showConfirmationModal('Approve Payroll?', 'success', 'Are you sure you want to approve this payroll? This action cannot be undone.');
        }

        function handleRejectPayroll() {
            pendingAction = 'rejected';
            showConfirmationModal('Reject Payroll?', 'danger', 'Are you sure you want to reject this payroll? This action cannot be undone.', true);
        }

        function handleConfirmAction() {
            if (currentPayrollIdx !== null && pendingAction) {
                if (pendingAction === 'rejected') {
                    const remarks = document.getElementById('remarksInput').value.trim();
                    if (!remarks) {
                        document.getElementById('remarksError').style.display = 'block';
                        return;
                    }
                    document.getElementById('remarksError').style.display = 'none';
                    payrolls[currentPayrollIdx].remarks = remarks;
                }
                payrolls[currentPayrollIdx].status = pendingAction;
                renderPayrolls();
                
                // Hide both modals
                const confirmModal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
                const viewModal = bootstrap.Modal.getInstance(document.getElementById('viewPayrollModal'));
                confirmModal.hide();
                viewModal.hide();
                
                currentPayrollIdx = null;
                pendingAction = null;
            }
        }

        function showConfirmationModal(title, type, message, showRemarks = false) {
            const icon = type === 'success' ? 'check-circle' : 'times-circle';
            const color = type === 'success' ? 'success' : 'danger';
            
            document.getElementById('confirmIcon').innerHTML = `<i class="fas fa-${icon} fa-3x text-${color}"></i>`;
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmModalBody').innerHTML = `<span class="text-${color} fw-bold">${message}</span>`;
            document.getElementById('remarksFormContainer').style.display = showRemarks ? 'block' : 'none';
            
            const confirmBtn = document.getElementById('confirmActionBtn');
            confirmBtn.className = `btn btn-${color} px-4`;
            confirmBtn.innerHTML = `<i class="fas fa-${icon === 'check-circle' ? 'check' : 'times'}"></i> Yes, ${title.split('?')[0]}`;
            
            if (showRemarks) {
                document.getElementById('remarksInput').value = '';
                document.getElementById('remarksError').style.display = 'none';
            }
            
            const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
            confirmModal.show();
        }

        // Print and download handlers
        function handlePrintSummary() {
            const filtered = filterAndSortPayrolls();
            document.getElementById('payrollSummaryContent').innerHTML = getPayrollSummaryHTML(filtered);
            const summaryModal = new bootstrap.Modal(document.getElementById('payrollSummaryModal'));
            summaryModal.show();
        }

        function handlePrintPayrollSummary() {
            const printContents = document.getElementById('payrollSummaryPrintArea').outerHTML;
            const originalContents = document.body.innerHTML;
            document.body.innerHTML = printContents;
            window.print();
            document.body.innerHTML = originalContents;
            window.location.reload();
        }

        function handleDownloadPayrollSummary() {
            // Your existing download PDF code
            // ... existing code ...
        }

        // Keep your existing helper functions (filterAndSortPayrolls, renderPayrolls, etc.)
        // ... existing code ...
    </script>
</body>
</html>
