<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Properties - Real Estate Website</title>
    <link rel="stylesheet" href="/public/css/crm_style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<!-- navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-black fixed-top">


    <div class="container-fluid">
        <a class="navbar-brand" href="#">
            <img src="/public/image/mdb.jpg" alt="mdb" class="img-fluid logo-img">

        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
            data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
            aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto mb-2 mg-lg-0">
                <li class="nav-item">
                    <a class="nav-link active" href="/crm/index">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/crm/list_properties">Properties</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/crm/developer">Developers</a>
                <li class="nav-item">
                    <a class="nav-link" href="/crm/faqs">FAQ's</a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="/crm/contact">Contact Us</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/crm/application">Join Us</a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="/">Login</a>
                </li>
            </ul>

        </div>
    </div>
</nav>

<!-- Properties Section -->
<section id="properties" class="container mt-5 pt-5">

    <h2 class="text-center mb-4" style="color: #4f6ef5; font-weight: bold;">Our Properties</h2>

    <!-- Filter Bar -->
    <div class="bg-dark text-light p-4 rounded mb-4">
        <form class="row g-3 align-items-end">
            <div class="col-md-3">
                <label for="city" class="form-label">City</label>
                <select class="form-select" id="city">
                    <option selected>All</option>
                    <option>Naic</option>
                    <option>Rosario</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="municipality" class="form-label">Municipality</label>
                <select class="form-select" id="municipality">
                    <option selected>All</option>
                    <option>Batangas</option>
                    <option>Cavite</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="minPrice" class="form-label">Min Price (₱)</label>
                <input type="number" class="form-control" id="minPrice" placeholder="e.g. 1000000">
            </div>
            <div class="col-md-3">
                <label for="maxPrice" class="form-label">Max Price (₱)</label>
                <input type="number" class="form-control" id="maxPrice" placeholder="e.g. 5000000">
            </div>
            <div class="col-md-3">
                <label for="project" class="form-label">Project</label>
                <select class="form-select" id="project">
                    <option selected>All</option>
                    <option>Tiarra Premiere</option>
                    <option>Cielo Townhouse</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="propertyType" class="form-label">Property Type</label>
                <select class="form-select" id="propertyType">
                    <option selected>All</option>
                    <option>Townhouse</option>
                    <option>Lot</option>
                </select>
            </div>
            <div class="col-md-6 d-flex justify-content-end">
                <button type="reset" class="btn btn-outline-light me-2">Reset</button>
                <button type="submit" class="btn btn-warning">Search</button>
            </div>
        </form>
    </div>

    <!-- Dynamic Property List -->
    <div id="propertyList"></div>

</section>

<!-- Request Tripping Modal (should be outside the dynamic property list) -->
<div class="modal fade" id="trippingModal" tabindex="-1" aria-labelledby="trippingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-light">
            <div class="modal-header">
                <h5 class="modal-title" id="trippingModalLabel">Request Tripping</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="trippingForm">
                    <div class="mb-3">
                        <label for="firstName" class="form-label">First Name</label>
                        <input type="text" class="form-control" id="firstName" required>
                    </div>
                    <div class="mb-3">
                        <label for="lastName" class="form-label">Last Name</label>
                        <input type="text" class="form-control" id="lastName" required>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="contactNumber" class="form-label">Contact Number</label>
                        <input type="text" class="form-control" id="contactNumber" required>
                    </div>
                    <div class="mb-3">
                        <label for="preferredDate" class="form-label">Preferred Date</label>
                        <input type="date" class="form-control" id="preferredDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="property" class="form-label">Property</label>
                        <input type="text" class="form-control" id="property" readonly>
                    </div>
                    <button type="submit" class="btn btn-dark w-100">Submit Request</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<footer class="bg-dark text-light pt-4">
    <div class="container">
        <div class="row">
            <div class="col-lg-5">
                <h5>About Us</h5>
                <p>M.D. Buendia Construction Inc. specializes in high-quality residential construction...</p>
            </div>
            <div class="col-lg-4">
                <h5>Contacts</h5>
                <p><i class="fa fa-map-marker-alt"></i> Naic, Cavite</p>
                <p><i class="fa fa-phone"></i> (92) 0325 12344567</p>
                <p><i class="fa fa-envelope"></i> mdb_engineering@yahoo.com</p>
            </div>
            <div class="col-lg-3">
                <h5>Stay Connected</h5>
                <ul class="list-unstyled">
                    <li><a href="#"><i class="fab fa-facebook"></i> Facebook</a></li>
                    <li><a href="#"><i class="fab fa-linkedin"></i> LinkedIn</a></li>
                    <li><a href="#"><i class="fab fa-instagram"></i> Instagram</a></li>
                    <li><a href="#"><i class="fab fa-twitter"></i> Twitter</a></li>
                </ul>
            </div>
        </div>
        <hr>
        <p class="text-center mb-0">© 2025 <a href="#">M.D. BUENDIA</a>. All Rights Reserved.</p>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js">

</script>
<script>
// Dynamically set API_URL based on current origin
const API_URL = window.location.hostname === 'localhost' 
    ? 'http://localhost:4000/crm' 
    : `${window.location.origin}/crm`;

// Handle the "Request Tripping" button click
document.querySelectorAll(".btn-warning.text-dark").forEach(button => {
    button.addEventListener("click", function(event) {
        // Get the property name from the data attribute
        const property = this.getAttribute("data-property");

        // Set the value of the property input in the form
        document.getElementById("property").value = property;

        // Optionally, open the modal with the form if not already open
        const modal = bootstrap.Modal.getInstance(document.getElementById('trippingModal'));
        modal.hide();
            });
    });

    const today = new Date().toISOString().split('T')[0]; // Get current date in YYYY-MM-DD format

// Set the minimum date in the input field
    const preferredDateInput = document.getElementById("preferredDate");
    if (preferredDateInput) {
        preferredDateInput.setAttribute("min", today);
    }

    // Handle form submission for site visit request
    const trippingForm = document.getElementById("trippingForm");
    if (trippingForm) {
        trippingForm.addEventListener("submit", async function(event) {
            event.preventDefault();

            // Get form elements
            const firstNameInput = document.getElementById("firstName");
            const lastNameInput = document.getElementById("lastName");
            const emailInput = document.getElementById("email");
            const contactNumberInput = document.getElementById("contactNumber");
            const preferredDateInput = document.getElementById("preferredDate");
            const propertyInput = document.getElementById("property");

            // Log form values for debugging
            console.log('Form Values:', {
                firstName: firstNameInput?.value,
                lastName: lastNameInput?.value,
                email: emailInput?.value,
                contactNumber: contactNumberInput?.value,
                preferredDate: preferredDateInput?.value,
                property: propertyInput?.value
            });

            // Validate all required fields exist
            const requiredFields = {
                firstName: firstNameInput?.value?.trim(),
                lastName: lastNameInput?.value?.trim(),
                email: emailInput?.value?.trim(),
                contactNumber: contactNumberInput?.value?.trim(),
                preferredDate: preferredDateInput?.value,
                property: propertyInput?.value?.trim()
            };

            // Check for missing or empty fields
            const missingFields = Object.entries(requiredFields)
                .filter(([_, value]) => !value)
                .map(([key]) => key);

            if (missingFields.length > 0) {
                console.error('Missing fields:', missingFields);
                alert(`Please fill in all required fields: ${missingFields.join(', ')}`);
                return;
            }

            // Validate email format
            if (!emailInput.value.includes('@') || !emailInput.value.includes('.')) {
                alert("Please enter a valid email address");
                return;
            }

            // Validate date is not in the past
            const selectedDate = new Date(preferredDateInput.value);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (selectedDate < today) {
                alert("Please select a future date for the site visit");
                return;
            }

            // Prepare form data
            const formData = {
                firstName: firstNameInput.value.trim(),
                lastName: lastNameInput.value.trim(),
                email: emailInput.value.trim(),
                contactNumber: contactNumberInput.value.trim(),
                preferredDate: preferredDateInput.value,
                property: propertyInput.value.trim()
            };

            // Log the final form data being sent
            console.log('Submitting form data:', formData);

            try {
                // Show loading state
                const submitButton = this.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Submitting...';

                const response = await fetch(`${API_URL}/submitVisitRequest`, {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                // Log the raw response for debugging
                console.log('Response status:', response.status);
                const responseText = await response.text();
                console.log('Response text:', responseText);

                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    console.error('Error parsing response:', e);
                    throw new Error('Invalid server response');
                }

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to submit request');
                }

                // Success
                alert(result.message || "Your site visit request has been submitted successfully!");
                
                // Reset form and close modal
                this.reset();
                const modal = bootstrap.Modal.getInstance(document.getElementById('trippingModal'));
                modal.hide();

            } catch (error) {
                console.error('Error submitting form:', error);
                alert(error.message || "Error submitting the request. Please try again.");
            } finally {
                // Reset button state
                const submitButton = this.querySelector('button[type="submit"]');
                submitButton.disabled = false;
                submitButton.innerHTML = 'Submit Request';
            }
        });
    }

async function loadProperties() {
    const container = document.getElementById('propertyList');
    container.innerHTML = '';
    try {
        const response = await fetch('/crm/properties');
        const properties = await response.json();
        properties.forEach(property => {
            const row = document.createElement('div');
            row.className = 'row mb-5';
            row.innerHTML = `
                <div class="col-lg-6">
                    <img src="/uploads/properties/${property.imageUrl}" alt="${property.name}" class="img-fluid rounded shadow-lg" style="width: 100%; height: 300px; object-fit: cover;">
                </div>
                <div class="col-lg-6">
                    <h3>${property.name}</h3>
                    <p>${property.description}</p>
                    <p><strong>${property.price}</strong></p>
                    <p>
                        <i class="fa fa-car"></i> ${property.parking} Parking &nbsp;&nbsp;
                        <i class="fa fa-bed"></i> ${property.bedrooms} Bedrooms &nbsp;&nbsp;
                        <i class="fa fa-bath"></i> ${property.bathrooms} Bathrooms &nbsp;&nbsp;
                        <i class="fa fa-layer-group"></i> ${property.floors} Floors
                    </p>
                    <div class="d-flex flex-wrap gap-2 mt-3">
                        <a href="/crm/vtour" class="btn btn-primary" target="_blank">
                            <i class="fa fa-eye"></i> View Virtual Tour
                        </a>
                        <button class="btn btn-warning text-dark request-tripping-btn" data-property="${property.name}" data-bs-toggle="modal" data-bs-target="#trippingModal">
                            <i class="fa fa-car"></i> Request Site Visit
                        </button>
                    </div>
                </div>
            `;
            container.appendChild(row);
        });
    } catch (error) {
        container.innerHTML = '<p class="text-danger">Failed to load properties.</p>';
        console.error(error);
    }
}
// Call on page load
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadProperties);
} else {
    loadProperties();
}
// Handle the "Request Site Visit" button click for dynamic properties
// Use event delegation
const propertyList = document.getElementById('propertyList');
propertyList.addEventListener('click', function(event) {
    if (event.target.closest('.request-tripping-btn')) {
        const button = event.target.closest('.request-tripping-btn');
        const property = button.getAttribute('data-property');
        document.getElementById('property').value = property;
    }
});

// Example fix for addEventListener error
const virtualTourInput = document.getElementById('virtual_tour_image');
if (virtualTourInput) {
    virtualTourInput.addEventListener('click', function(e) {
        e.preventDefault();
        // your code here (if needed)
    });
}

  </script>
  
</body>
</html>
